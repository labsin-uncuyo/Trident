#!/bin/bash

# Experiment runner script
# Manages docker containers for running a single experiment

set -e

# Configuration
EXPERIMENT_ID="${1:-$(date +%s)}"
LAB_PASSWORD="${LAB_PASSWORD:-admin123}"
PCAP_ROTATE_SECS="${PCAP_ROTATE_SECS:-5}"
SLIPS_PROCESS_ACTIVE="${SLIPS_PROCESS_ACTIVE:-1}"
SLIPS_WATCH_INTERVAL="${SLIPS_WATCH_INTERVAL:-1}"
DEFENDER_PORT="${DEFENDER_PORT:-8000}"

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTPUTS_DIR="$PROJECT_ROOT/outputs"
EXPERIMENT_OUTPUTS="$OUTPUTS_DIR/$EXPERIMENT_ID"
RUN_ID_FILE="$PROJECT_ROOT/outputs/.current_run"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging
log() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS:${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1"
}

# Check if required tools are available
check_prerequisites() {
    log "Checking prerequisites..."

    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed or not in PATH"
        exit 1
    fi

    if ! command -v make &> /dev/null; then
        log_error "Make is not installed or not in PATH"
        exit 1
    fi

    if [[ ! -f "$PROJECT_ROOT/Makefile" ]]; then
        log_error "Makefile not found: $PROJECT_ROOT/Makefile"
        exit 1
    fi

    log_success "Prerequisites check passed"
}

# Clean up any existing containers and networks
cleanup() {
    log "Cleaning up existing containers..."

    # Use main Makefile to clean up
    cd "$PROJECT_ROOT"
    make down || true

    # Wait for containers to fully stop
    sleep 5

    log_success "Cleanup completed"
}

# Set up experiment environment
setup_environment() {
    log "Setting up experiment environment for ID: $EXPERIMENT_ID"

    # Create outputs directory
    mkdir -p "$EXPERIMENT_OUTPUTS"/{pcaps,slips_output,logs}

    # Set RUN_ID in the Makefile's run ID file
    echo "$EXPERIMENT_ID" > "$RUN_ID_FILE"

    # Create .env file if it doesn't exist
    if [[ ! -f "$PROJECT_ROOT/.env" ]]; then
        log "Creating .env file with default values..."
        cat > "$PROJECT_ROOT/.env" << EOF
# Generated by run_experiment.sh
RUN_ID=$EXPERIMENT_ID
LAB_PASSWORD=$LAB_PASSWORD
PCAP_ROTATE_SECS=$PCAP_ROTATE_SECS
SLIPS_PROCESS_ACTIVE=$SLIPS_PROCESS_ACTIVE
SLIPS_WATCH_INTERVAL=$SLIPS_WATCH_INTERVAL
DEFENDER_PORT=$DEFENDER_PORT
EOF
    else
        log "Updating .env file with experiment ID..."
        sed -i "s/^RUN_ID=.*/RUN_ID=$EXPERIMENT_ID/" "$PROJECT_ROOT/.env"
    fi

    log_success "Environment setup completed"
}

# Start the lab infrastructure
start_infrastructure() {
    log "Starting lab infrastructure using main Makefile..."

    cd "$PROJECT_ROOT"

    # Export environment variables
    export RUN_ID="$EXPERIMENT_ID"
    export LAB_PASSWORD="$LAB_PASSWORD"
    export PCAP_ROTATE_SECS="$PCAP_ROTATE_SECS"
    export SLIPS_PROCESS_ACTIVE="$SLIPS_PROCESS_ACTIVE"
    export SLIPS_WATCH_INTERVAL="$SLIPS_WATCH_INTERVAL"
    export DEFENDER_PORT="$DEFENDER_PORT"

    # Start services using make up
    make up

    log_success "Infrastructure startup initiated"
}

# Wait for services to be healthy
wait_for_services() {
    log "Waiting for services to become healthy..."

    cd "$PROJECT_ROOT"

    # Use the make verify command which includes health checks
    if make verify; then
        log_success "All services are healthy!"
        return 0
    else
        log_error "Services failed health checks"
        return 1
    fi
}

# Execute attack script on compromised container
execute_attack() {
    log "Executing attack script on compromised container..."

    # Copy attack script to container
    docker cp "$PROJECT_ROOT/scripts/defender_experiments/attack_script.sh" lab_compromised:/tmp/attack_script.sh

    # Make it executable and run it
    docker exec lab_compromised chmod +x /tmp/attack_script.sh

    log "Starting attack (experiment ID: $EXPERIMENT_ID)..."
    docker exec lab_compromised /tmp/attack_script.sh "$EXPERIMENT_ID"

    log_success "Attack execution completed"
}

# Wait for attack to complete and collect results
collect_results() {
    log "Collecting experiment results..."

    # Wait a bit for all packets to be captured
    sleep 10

    # Copy attack logs from compromised container
    docker cp lab_compromised:/tmp/attack_log.txt "$EXPERIMENT_OUTPUTS/logs/" 2>/dev/null || true
    docker cp lab_compromised:/tmp/attack_summary.json "$EXPERIMENT_OUTPUTS/logs/" 2>/dev/null || true
    docker cp lab_compromised:/tmp/nmap_discovery.txt "$EXPERIMENT_OUTPUTS/logs/" 2>/dev/null || true
    docker cp lab_compromised:/tmp/nmap_ports.txt "$EXPERIMENT_OUTPUTS/logs/" 2>/dev/null || true
    docker cp lab_compromised:/tmp/hydra_results.txt "$EXPERIMENT_OUTPUTS/logs/" 2>/dev/null || true

    # Collect SLIPS output
    mkdir -p "$EXPERIMENT_OUTPUTS/slips_output"
    if docker ps --format "table {{.Names}}" | grep -q "lab_slips_defender"; then
        docker cp lab_slips_defender:/StratosphereLinuxIPS/output/ "$EXPERIMENT_OUTPUTS/slips_output/" 2>/dev/null || true
    fi

    # List PCAP files collected
    if [[ -d "$EXPERIMENT_OUTPUTS/pcaps" ]]; then
        local pcap_count=$(find "$EXPERIMENT_OUTPUTS/pcaps" -name "*.pcap" | wc -l)
        log "Collected $pcap_count PCAP files"
    fi

    log_success "Results collection completed"
}

# Analyze collected PCAP files
analyze_pcaps() {
    log "Analyzing PCAP files for experiment $EXPERIMENT_ID..."

    if [[ ! -d "$EXPERIMENT_OUTPUTS/pcaps" ]]; then
        log_warning "No PCAP directory found, skipping analysis"
        return 0
    fi

    local pcap_count=$(find "$EXPERIMENT_OUTPUTS/pcaps" -name "*.pcap" | wc -l)
    if [[ $pcap_count -eq 0 ]]; then
        log_warning "No PCAP files found, skipping analysis"
        return 0
    fi

    log "Found $pcap_count PCAP files, starting analysis..."

    # Run PCAP analysis
    local analyze_script="$SCRIPT_DIR/analyze_pcaps.py"
    if [[ -f "$analyze_script" ]]; then
        python3 "$analyze_script" "$EXPERIMENT_OUTPUTS/pcaps" --output "$EXPERIMENT_OUTPUTS/pcap_analysis.json"
        if [[ $? -eq 0 ]]; then
            log_success "PCAP analysis completed successfully"
            log "Analysis saved to: $EXPERIMENT_OUTPUTS/pcap_analysis.json"
        else
            log_error "PCAP analysis failed"
        fi
    else
        log_error "PCAP analysis script not found: $analyze_script"
    fi
}

# Stop the infrastructure
stop_infrastructure() {
    log "Stopping infrastructure using main Makefile..."

    cd "$PROJECT_ROOT"
    make down

    log_success "Infrastructure stopped"
}

# Main execution function
run_experiment() {
    local start_time=$(date +%s)

    log "Starting experiment $EXPERIMENT_ID"
    log "Start time: $(date)"

    # Clean up any existing environment using make down
    log "Cleaning up existing environment with make down..."
    cd "$PROJECT_ROOT"
    make down || log_warning "make down failed, continuing..."

    # Execute experiment phases
    check_prerequisites
    cleanup
    setup_environment
    start_infrastructure
    wait_for_services

    log "All services ready, executing attack in 10 seconds..."
    sleep 10

    execute_attack
    collect_results
    analyze_pcaps
    stop_infrastructure

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    log_success "Experiment $EXPERIMENT_ID completed successfully!"
    log "Duration: ${duration}s"
    log "Results saved in: $EXPERIMENT_OUTPUTS"

    # Create experiment summary
    cat > "$EXPERIMENT_OUTPUTS/experiment_summary.json" << EOF
{
    "experiment_id": "$EXPERIMENT_ID",
    "start_time": "$(date -d @$start_time -Iseconds)",
    "end_time": "$(date -d @$end_time -Iseconds)",
    "duration_seconds": $duration,
    "status": "completed",
    "pcap_count": $(find "$EXPERIMENT_OUTPUTS/pcaps" -name "*.pcap" 2>/dev/null | wc -l),
    "lab_password": "$LAB_PASSWORD",
    "defender_port": $DEFENDER_PORT
}
EOF
}

# Handle script interruption
interrupt_handler() {
    log_warning "Experiment interrupted! Cleaning up..."
    stop_infrastructure
    exit 1
}

# Set up interrupt handlers
trap interrupt_handler INT TERM

# Show usage
usage() {
    echo "Usage: $0 [EXPERIMENT_ID]"
    echo "  EXPERIMENT_ID: Optional unique identifier for the experiment (defaults to timestamp)"
    echo ""
    echo "Environment variables:"
    echo "  LAB_PASSWORD: SSH password for containers (default: P@ssw0rd123!)"
    echo "  PCAP_ROTATE_SECS: PCAP rotation interval in seconds (default: 5)"
    echo "  SLIPS_PROCESS_ACTIVE: Enable SLIPS processing (default: 1)"
    echo "  SLIPS_WATCH_INTERVAL: SLIPS watch interval in seconds (default: 1)"
    echo "  DEFENDER_PORT: Defender API port (default: 8000)"
    exit 1
}

# Parse arguments
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
fi

# Run the experiment
run_experiment