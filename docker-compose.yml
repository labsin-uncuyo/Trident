services:
  router:
    build: ./images/router
    image: lab/router:latest
    container_name: lab_router
    profiles:
      - core
    privileged: true
    environment:
      - RUN_ID=${RUN_ID}
    volumes:
      - ./outputs:/outputs
    networks:
      lab_net_a:
        ipv4_address: 172.30.0.1
      lab_net_b:
        ipv4_address: 172.31.0.1
    healthcheck:
      test: ["CMD-SHELL", "sysctl net.ipv4.ip_forward | grep -q ' = 1'"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  slips_defender:
    build: ./images/slips_defender
    image: lab/slips_defender:latest
    container_name: lab_slips_defender
    profiles:
      - defender
    environment:
      - RUN_ID=${RUN_ID}
      - DEFENDER_PORT=${DEFENDER_PORT:-8000}
      - PLANNER_PORT=${PLANNER_PORT:-1654}
      - PLANNER_URL=${PLANNER_URL:-http://127.0.0.1:8000/plan}
      - OPENCODE_TIMEOUT=${OPENCODE_TIMEOUT:-1200}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - LAB_PASSWORD=${LAB_PASSWORD}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY}
    volumes:
      - ./outputs/${RUN_ID}/pcaps:/StratosphereLinuxIPS/dataset
      - ./outputs/${RUN_ID}/slips:/StratosphereLinuxIPS/output
      - ./outputs:/outputs
      - ./images/slips_defender:/opt/lab
      - ./images/slips_defender/slips.yaml:/StratosphereLinuxIPS/config/slips.yaml
      - ./images/slips_defender/local.zeek:/StratosphereLinuxIPS/config/local.zeek
      - ./images/slips_defender/__load__.zeek:/StratosphereLinuxIPS/__load__.zeek
      - slips_redis_data:/var/lib/redis
      - slips_ti_data:/StratosphereLinuxIPS/modules/threat_intelligence/remote_data_files
      - auto_responder_ssh_keys:/root/.ssh
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    command: ["/bin/bash", "/opt/lab/slips_entrypoint.sh"]
    restart: unless-stopped
    depends_on:
      router:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:${DEFENDER_PORT:-8000}/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30

  compromised:
    build: ./images/compromised
    image: lab/compromised:latest
    container_name: lab_compromised
    init: true
    profiles:
      - core
    environment:
      - LAB_PASSWORD=${LAB_PASSWORD}
      - RUN_ID=${RUN_ID}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - LLM_MODEL=${LLM_MODEL}
    volumes:
      - ./outputs:/outputs
      - ./images/compromised/secrets/authorized_keys:/secrets/authorized_keys:ro
      - auto_responder_ssh_keys:/root/.ssh_auto_responder:ro
    networks:
      lab_net_a:
        ipv4_address: 172.30.0.10
    dns:
      - 172.30.0.1
    depends_on:
      server:
        condition: service_healthy
      router:
        condition: service_healthy
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD-SHELL", "ss -ltn | grep -q ':22'"]
      interval: 5s
      timeout: 3s
      retries: 20

 

  server:
    build: ./images/server
    image: lab/server:latest
    container_name: lab_server
    profiles:
      - core
    privileged: true
    environment:
      - RUN_ID=${RUN_ID}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY}
      - LAB_PASSWORD=${LAB_PASSWORD}
      - LOGIN_USER=${LOGIN_USER:-admin}
      - LOGIN_PASSWORD=${LOGIN_PASSWORD:-admin}
    volumes:
      - ./outputs:/outputs
      - opencode_data:/root/.opencode
      - postgres_data:/var/lib/postgresql
      - ./.env:/etc/default/lab-env:ro
      - auto_responder_ssh_keys:/root/.ssh_auto_responder:ro
    networks:
      lab_net_b:
        ipv4_address: 172.31.0.10
    dns:
      - 172.31.0.1
    depends_on:
      router:
        condition: service_healthy
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:80 >/dev/null && pg_isready -q || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  aracne_attacker:
    build:
      context: .
      dockerfile: images/aracne/Dockerfile
    image: lab/aracne:latest
    container_name: lab_aracne_attacker
    profiles:
      - attackers
    env_file:
      - ./configs/aracne_lab/.env
    environment:
      - RUN_ID=${RUN_ID}
      - GOAL=${GOAL:-Create the file /home/labuser/aracne_was_here.txt containing 'aracne ok' and then read it back to confirm.}
      - SSH_HOST=172.30.0.10
      - SSH_PORT=22
    volumes:
      - ./outputs/${RUN_ID}/aracne:/logs
      - ./configs/aracne_lab/config:/agent/config:ro
      - ./configs/aracne_lab/.env:/agent/.env:ro
      - ./configs/aracne_lab/start_lab.sh:/agent/start_lab.sh:ro
    networks:
      lab_net_b:
        ipv4_address: 172.31.0.50
    dns:
      - 172.31.0.1
    cap_add:
      - NET_ADMIN
    depends_on:
      compromised:
        condition: service_healthy
    entrypoint: ["/bin/bash", "/agent/start_lab.sh"]

volumes:
  opencode_data:
  postgres_data:
  slips_redis_data:
  slips_ti_data:
  auto_responder_ssh_keys:

networks:
  lab_net_a:
    name: lab_net_a
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.254
  lab_net_b:
    name: lab_net_b
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/24
          gateway: 172.31.0.254
